# Sonar Test - Audio Transcription and Analysis Platform

## Overview

This is a comprehensive audio transcription and analysis platform that combines a Flask backend with a modern JavaScript frontend. The system appears to be designed for processing audio files, generating transcripts, and providing interactive editing capabilities.

## Architecture

The project consists of two main components:
1. **Backend (Flask)**: Located in the `explore/` directory, provides API endpoints for audio processing, transcript management, and data persistence
2. **Frontend (JavaScript)**: Located in the `v2/` directory, provides an interactive web interface for audio playback and transcript editing

## Project Structure

### Backend Structure (`explore/`)
- `app/`: Main Flask application package
  - `routes/`: API route handlers
  - `services/`: Business logic services
  - `transcripts/`: Transcript processing modules
  - `static/`: Static web assets (CSS, JS, images)
  - `templates/`: HTML templates
- `run.py`: Application entry point
- `wsgi.py`: WSGI configuration
- `requirements.txt`: Python dependencies

### Frontend Structure (`v2/`)
- `core/`: Core application state management
- `data/`: Data layer and API communication
- `editor/`: Transcript editing functionality
- `history/`: Version control and history management
- `player/`: Audio playback components
- `render/`: Rendering and visualization
- `shared/`: Shared utilities and protocols
- `ui/`: User interface components
- `workers/`: Web workers for background processing

## Core Application Files

### Entry Points

#### `run.py` - Main Application Bootstrap
This is the primary entry point for the application with comprehensive CLI argument parsing and initialization:

**Key Functions:**
- **`timeit(name: str)`**: Decorator function that measures and logs execution time for operations
- **`init_app(data_dir: str)`**: Initializes the Flask application with timing instrumentation
- **`init_file_service(json_dir: Path, audio_dir: Path)`**: Scans and loads transcript files from the data directory
- **`build_index(file_records, force: bool, index_file: str | None = None)`**: Builds the search index from transcript data

**CLI Arguments:**
- `--data-dir`: Path to data directory containing 'json/' and 'audio/' subdirectories (default: ../data)
- `--index-file`: Custom index file path (auto-generated by default)
- `--force-reindex`: Rebuild in-memory index even if it appears fresh
- `--port`: Server port (443 for production, 5000 for development)
- `--dev`: Run in HTTP development mode without SSL
- `--ssl-cert`/`--ssl-key`: SSL certificate paths for production

**Logging Configuration:**
- Uses `JsonFormatter` for structured logging to files
- Supports log level override via `LOG_LEVEL` or `EXPLORE_LOG_LEVEL` environment variables
- Implements log rotation with 10MB max file size and 5 backup files
- Quiet mode available via WARNING level to suppress verbose output

**Production vs Development:**
- Development mode: HTTP on 127.0.0.1:5000 with Flask debug capabilities
- Production mode: HTTPS with Let's Encrypt certificates, threaded server

#### `wsgi.py` - WSGI Configuration
Simple WSGI entry point for production deployment:
- Determines data directory from `DATA_DIR` environment variable or defaults to `../data`
- Creates Flask app instance for WSGI servers (gunicorn, uWSGI, etc.)

#### `app.py` - Alternative Entry Point
Alternative entry point with similar functionality to `run.py` but with simpler argument handling:
- Supports `--data-dir` command line argument
- Falls back to `DATA_DIR` environment variable
- Runs on all interfaces (0.0.0.0) by default

### Dependencies

#### Python Dependencies (`explore/requirements.txt`)
- **Flask 2.0+**: Web framework
- **Click 8.0+**: CLI interface framework
- **orjson**: Fast JSON serialization
- **python-dotenv**: Environment variable management
- **tqdm**: Progress bars
- **flask-oauthlib**: OAuth authentication
- **Authlib**: Authentication library
- **regex**: Advanced regex support
- **duckdb**: Embedded SQL database
- **pandas**: Data manipulation
- **werkzeug <2.1**: WSGI toolkit (version constraint)
- **posthog**: Analytics tracking
- **requests**: HTTP client
- **pytest**: Testing framework

#### JavaScript Dependencies (`package.json`)
- **@playwright/test**: End-to-end testing framework
- **crypto-js**: Cryptographic functions
- **@types/node**: TypeScript definitions

**Available Scripts:**
- `npm run e2e`: Run end-to-end tests
- `npm run e2e:headed`: Run tests with browser UI
- `npm run e2e:install`: Install Playwright browsers

## Flask Application Architecture

### Core Application Initialization (`explore/app/__init__.py`)

The Flask application factory pattern is implemented in `create_app()` with comprehensive configuration and service initialization.

**Key Components:**

#### DuplicateLogFilter Class
- **Purpose**: Suppresses consecutive duplicate log records and reports counts
- **Features**: 
  - Thread-safe duplicate detection using message keys
  - Configurable notice threshold (default: 100 duplicates)
  - Automatic notice emission when threshold reached
  - Flush pending notices on application exit

#### Application Configuration
**Path Configuration:**
- `DATA_DIR`: Root data directory path
- `AUDIO_DIR`: Audio files directory (`<DATA_DIR>/audio`)
- `TRANSCRIPTS_DIR`: Transcript JSON files directory (`<DATA_DIR>/json`)
- `INDEX_FILE`: Custom index file path
- `SQLITE_PATH`: SQLite database path (`<DATA_DIR>/explore.sqlite`)

**Analytics Configuration:**
- PostHog integration for user analytics
- Configurable via environment variables (`POSTHOG_API_KEY`, `POSTHOG_HOST`)
- Can be disabled via `DISABLE_ANALYTICS` environment variable

**Alignment Service Configuration:**
- `ALIGN_PREALIGN_ON_SAVE`: Whether to pre-align transcripts on save (default: True)
- `AUDIO_LOG_DIR`: Directory for audio processing logs
- `AUDIO_LOG_NATIVE`: Enable native audio logging (default: True)
- `ALIGN_ENDPOINT`: External alignment service endpoint

#### Security & Authentication
- **Secret Key**: Set from `SECRET_KEY` environment variable (defaults to 'dev-secret-key')
- **Google OAuth**: Integrated using Authlib with automatic initialization if credentials provided
- **CORS Configuration**: Configurable allowed origins via `ALLOWED_ORIGINS` environment variable

#### Service Integration
**Index Manager**: Initializes search index with transcript data
**Analytics Service**: PostHog integration for user behavior tracking
**Audio Index**: Pre-built mapping of audio file paths for fast resolution

#### Blueprint Registration
Registers the following route blueprints:
- `main`: Core application routes
- `search`: Search functionality
- `auth`: Authentication routes
- `export`: Data export functionality
- `audio`: Audio file serving
- `transcripts`: Transcript management
- `browser`: Browser-specific routes
- `frontend`: Static frontend assets

### Utility Functions (`explore/app/utils.py`)

#### FileRecord Class
- **Purpose**: Represents a transcript file with metadata
- **Methods**:
  - `read_json()`: Reads and parses gzipped JSON transcript files using orjson for performance

#### Transcript Discovery (`get_transcripts()`)
- **Purpose**: Recursively finds all `full_transcript.json.gz` files
- **Features**:
  - Supports both legacy flat files (`<id>.json.gz`) and nested structure (`<source>/<id>/full_transcript.json.gz`)
  - Duplicate detection and warning
  - Returns sorted list of FileRecord objects

#### Text Normalization (`_norm_text()`)
- **Purpose**: Normalizes Unicode text for consistent processing
- **Features**:
  - NFC Unicode normalization
  - Removes control and format characters
  - Normalizes whitespace

#### Audio Path Resolution (`resolve_audio_path()`)
- **Purpose**: Resolves audio file paths from various storage layouts
- **Supported Layouts**:
  1. `<AUDIO_DIR>/<folder>/<file>.opus` (direct layout)
  2. `<AUDIO_DIR>/audio/<folder>/<hash>/<folder>/<file>.opus` (nested layout)
- **Features**:
  - Fast path using pre-built audio index
  - Git LFS pointer resolution
  - Symlink resolution
  - Recursive search fallback

#### Audio Index Building (`build_audio_index()`)
- **Purpose**: Creates mapping of `<folder>/<file>` to absolute paths
- **Features**:
  - Supports both flat and nested directory structures
  - Normalizes text for consistent key generation
  - Returns dictionary for fast path resolution

#### Pointer Resolution (`_maybe_pointer_to_blob()`)
- **Purpose**: Resolves Git LFS pointers and small text files to actual blob locations
- **Supported Formats**:
  - Git LFS pointers (spec v1)
  - Bare SHA hashes (40-64 hex characters)
  - Relative path references to blobs directory

## Services Layer

### Database Service (`explore/app/services/db.py`)

The `DatabaseService` class provides a thread-safe abstraction layer for SQLite database operations with advanced configuration options.

**Key Features:**
- **Thread-safe connections**: Uses thread-local storage for database connections
- **Connection pooling**: Tracks all connections for proper cleanup on Windows systems
- **Performance optimization**: Configurable cache size, busy timeout, and journal mode
- **WAL mode support**: Write-Ahead Logging for better concurrency
- **Custom UDF**: Registers `match_offsets()` function for pattern matching in search queries

**Configuration Options:**
- `cache_size`: Default 4GB cache (negative value in KB)
- `busy_timeout`: 5-second timeout for busy database scenarios
- `journal_mode`: Configurable via `SQLITE_JOURNAL` environment variable (default: WAL)
- `temp_store`: Memory-based temporary storage for non-index generation

**Methods:**
- `execute()`: Execute single SQL query with optional parameters
- `batch_execute()`: Execute query with multiple parameter sets for batch operations
- `commit()`: Commit current transaction
- `close()`: Close connection with WAL checkpoint and cleanup
- `close_all()`: Class method to close all tracked connections

### Index Manager (`explore/app/services/index.py`)

The `IndexManager` and `TranscriptIndex` classes provide comprehensive search indexing and retrieval capabilities.

#### TranscriptIndex Class
**Purpose**: Database-agnostic transcript index with query methods

**Key Methods:**
- `get_document_stats()`: Returns document count and total character count
- `get_segments_by_ids()`: Batch retrieval of segments by (doc_id, segment_id) pairs
- `get_segment_at_offset()`: Find segment containing specific character offset
- `get_source_by_episode_idx()`: Get document source by episode index
- `search_hits()`: Search for query and return (episode_idx, char_offset) pairs

**Database Schema:**
```sql
-- Documents table
CREATE TABLE documents (
    doc_id INTEGER PRIMARY KEY,
    source VARCHAR,
    episode VARCHAR,
    full_text TEXT
)

-- Segments table  
CREATE TABLE segments (
    doc_id INTEGER,
    segment_id INTEGER,
    segment_text TEXT,
    avg_logprob DOUBLE,
    char_offset INTEGER,
    start_time DOUBLE,
    end_time DOUBLE,
    FOREIGN KEY (doc_id) REFERENCES documents(doc_id)
)
```

#### IndexManager Class
**Purpose**: Manages transcript index creation, loading, and persistence

**Features:**
- **Multi-threaded indexing**: Uses ThreadPoolExecutor for parallel processing (max 4 threads)
- **Progress tracking**: tqdm progress bar during index building
- **Flexible data sources**: Can load from file records or existing index files
- **Transaction safety**: Each document processed in separate transaction
- **Performance metrics**: Tracks read, conversion, and append times

**Index Building Process:**
1. Setup database schema with performance optimizations
2. Clear existing data to allow rebuilds
3. Process files in parallel using thread pool
4. Convert JSON transcripts to string and segments format
5. Insert documents and segments in batches
6. Commit transactions per document

#### Helper Functions
- `_episode_to_string_and_segments()`: Converts Kaldi-style or plain list JSON to searchable format
- `segment_for_hit()`: Lookup segment containing specific character offset
- `_setup_schema()`: Create database schema with performance indexes

### Search Service (`explore/app/services/search.py`)

The `SearchService` class provides high-level search functionality over the transcript index.

**SearchHit Class:**
- `episode_idx`: Index of the episode containing the hit
- `char_offset`: Character offset within the episode text

**Key Methods:**
- `search(query: str)`: Performs search and returns list of SearchHit objects
- `segment(hit: SearchHit)`: Returns the segment containing a specific hit

**Features:**
- **Performance tracking**: Logs search execution time and result counts
- **Index statistics**: Reports document count and total characters on initialization
- **Stateless design**: No internal state, operates over current index

### Analytics Service (`explore/app/services/analytics_service.py`)

The `AnalyticsService` class provides comprehensive user behavior tracking using PostHog.

**Key Methods:**
- `identify_user()`: Identify users with optional properties
- `capture_event()`: Capture generic events with properties
- `capture_search()`: Specialized search event tracking with detailed metrics
- `capture_export()`: Track content export events
- `capture_error()`: Track error events with context

**Search Tracking Properties:**
- Query text, substring usage, pagination details
- Execution time, result counts, progressive loading status
- User email (if authenticated)

**Error Tracking Properties:**
- Error type and message, request URL and method
- User agent, additional context, user email

**Performance Decorator:**
- `@track_performance()`: Decorator for automatic function performance tracking
- Captures execution time, success status, and optional arguments
- Integrates with PostHog analytics

### Export Service (`explore/app/services/export_service.py`)

The `ExportService` class handles data export functionality including CSV and audio segment exports.

**Key Methods:**
- `export_results_csv()`: Export search results to CSV format with UTF-8 BOM
- `export_audio_segment()`: Extract and export audio segments using pydub

**Features:**
- **CSV Export**: Excel-compatible format with UTF-8 BOM
- **Audio Processing**: Uses pydub for audio manipulation and format conversion
- **Path Resolution**: Integrates with audio path resolution system
- **Error Handling**: Validates audio file existence and time bounds
- **Format Support**: Handles Opus audio format with proper conversion

## Transcript Processing Layer

### Transcript Schema Management (`explore/app/transcripts/schema.py`)

The schema management system provides versioned database schema evolution for transcript storage.

**Key Functions:**
- `ensure_schema()`: Creates or upgrades SQLite schema with version tracking
- `_get_user_version()` / `_set_user_version()`: Manages schema version using SQLite PRAGMA
- `_table_exists()` / `_column_exists()`: Helper functions for schema introspection

**Database Tables:**
1. **transcripts**: Main transcript storage with versioning
2. **transcript_edits**: Edit history with diff patches and token operations
3. **transcript_confirmations**: User confirmations for specific text ranges
4. **transcript_words**: Individual word-level timing and probability data

**Schema Evolution:**
- Version 1: Initial schema with basic tables
- Version 2: Added timestamp and metadata columns
- Version 3: Added transcript confirmations table

### Text Operations (`explore/app/transcripts/text_ops.py`)

Comprehensive text processing utilities for transcript manipulation and validation.

**Key Functions:**
- `compose_text_from_words()`: Reconstructs text from word tokens
- `canonicalize_text()`: Normalizes line endings and text format
- `diff_text()`: Generates unified diff between text versions
- `validate_and_sanitize_words()`: Validates word token structure and timing data
- `tokenize_text_to_words()`: Converts text to word tokens with position tracking
- `carry_over_token_timings()`: Preserves timing data when text changes
- `ensure_words_match_text()`: Ensures word tokens match text content
- `detect_changed_segments()`: Identifies which segments changed between versions

**Features:**
- **Timing Preservation**: Maintains word-level timing data across edits
- **Validation**: Comprehensive validation of timing data monotonicity
- **Text Normalization**: Handles Unicode, whitespace, and control characters
- **Segment Detection**: Tracks changes at segment level for efficient processing

### Timing Management (`explore/app/transcripts/timing.py`)

Advanced timing data validation and carry-over functionality with strict anti-artificial-timing policies.

**Critical Design Principles:**
- **NO ARTIFICIAL TIMING**: Never generates fake timing data
- **FAIL FAST**: Exposes timing bugs rather than hiding them
- **VALIDATION FIRST**: Validates timing data before processing

**Key Functions:**
- `validate_timing_data()`: Validates timing monotonicity and detects artificial patterns
- `carry_over_timings_from_db()`: Preserves timing data from previous versions
- `_assign_from_prev()`: Matches words with previous timing data
- `_build_prev_sequence_from_db()`: Loads previous timing data from database
- `_build_prev_sequence_from_baseline()`: Loads baseline timing from original transcripts

**Validation Features:**
- **Monotonicity Checks**: Ensures start ≤ end for all words
- **Floating-point Detection**: Identifies artificial timing patterns (e.g., "1.5999999999999999")
- **Cross-word Validation**: Ensures word sequences are temporally ordered
- **Space Token Handling**: Properly handles whitespace tokens without timing data

### Database Operations (`explore/app/transcripts/db_ops.py`)

Low-level database access functions for transcript storage and retrieval.

**Key Functions:**
- `latest_row()`: Retrieves most recent transcript version
- `row_for_version()`: Retrieves specific transcript version
- `populate_transcript_words()`: Stores word-level timing data
- `fetch_words_rows()`: Retrieves word data for segment ranges
- `normalize_end_times()`: Fixes timing monotonicity issues
- `normalize_db_words_rows()`: Processes database word rows
- `slice_words_json()`: Extracts word segments by index range
- `build_segment_filter()`: Builds SQL filters for segment queries

**Critical Warnings:**
- Functions include extensive documentation about NOT generating artificial timing data
- Emphasis on exposing bugs rather than masking them with fake data
- Proper NULL handling for missing timing information

### Alignment Service (`explore/app/transcripts/alignment.py`)

External alignment service integration for automatic timing adjustment.

**Key Functions:**
- `ffmpeg_extract_wav_clip()`: Extracts audio clips using FFmpeg
- `align_call()`: Calls external alignment service (silence-remover.com)
- `save_alignment_artifacts()`: Logs alignment requests and responses
- `explode_resp_words_if_needed()`: Handles multi-word alignment responses
- `build_new_window()`: Creates alignment windows from word segments
- `map_aligned_to_updates()`: Maps alignment results to word updates
- `prealign_updates()`: Pre-alignment processing for transcript saves

**Features:**
- **Audio Processing**: FFmpeg integration for audio clip extraction
- **External Service**: Integration with silence-remover.com alignment service
- **Artifact Logging**: Comprehensive logging of alignment requests/responses
- **Error Handling**: Graceful fallback when alignment fails
- **Timing Mapping**: Precise mapping of alignment results to word timestamps

### Transcript Utilities (`explore/app/transcripts/utils.py`)

Utility functions for transcript processing and validation.

**Key Functions:**
- `sha256_hex()`: Generates SHA-256 hashes for content verification
- `clamp_neighbors()`: Limits neighbor window size for alignment
- `log_info()`: Enhanced logging with deduplication and timestamps
- `ensure_safe_doc()`: Validates document identifiers for security
- `safe_name()`: Creates filesystem-safe names for logging artifacts

**Features:**
- **Security Validation**: Prevents path traversal attacks
- **Log Deduplication**: Reduces log spam from repeated messages
- **Content Hashing**: SHA-256 verification for data integrity
- **Safe Naming**: Filesystem-safe name generation

## Route Handlers

### Main Routes (`explore/app/routes/main.py`)

Core application routes for search and home page functionality.

**Key Routes:**
- `GET /`: Home page with authentication requirement
- `GET /search`: Search functionality with pagination and analytics tracking
- `GET /privacy`: Privacy policy page

**Search Features:**
- **Pagination**: Configurable results per page (default: 100)
- **Performance Tracking**: Execution time measurement and analytics
- **Result Enrichment**: Adds segment information to search hits
- **Multiple Output Formats**: JSON API and HTML template responses

**Global State Management:**
- Maintains global `search_service` and `file_records` instances
- Lazy initialization of search service on first request
- Integration with analytics service for user behavior tracking

### Search API (`explore/app/routes/search.py`)

Dedicated search API endpoints for programmatic access.

**Key Routes:**
- `GET /search/`: Basic search with regex support
- `POST /search/segment`: Get segment information for search hits
- `POST /search/segment/by_idx`: Batch segment retrieval by indices

**Features:**
- **Regex Support**: Optional regex pattern matching
- **Batch Operations**: Efficient bulk segment lookups
- **Error Handling**: Graceful handling of invalid lookups
- **JSON API**: Consistent JSON response format

### Transcript Management (`explore/app/routes/transcripts.py`)

Comprehensive transcript editing and versioning system.

**Key Routes:**
- `GET /transcripts/latest`: Get latest transcript version
- `GET /transcripts/get`: Get specific transcript version
- `POST /transcripts/save`: Save transcript with conflict detection
- `GET /transcripts/edits`: Get edit history
- `POST /transcripts/align_segment`: Align segment timing via external service
- `POST /transcripts/migrate_words`: Migrate word data between versions
- `GET /transcripts/confirmations`: Get user confirmations
- `POST /transcripts/confirmations/save`: Save user confirmations
- `GET /transcripts/history`: Get version lineage
- `GET /transcripts/words`: Get word-level data with segment filtering

**Advanced Features:**
- **Conflict Detection**: Prevents concurrent edit conflicts using SHA-256 hashing
- **Automatic Alignment**: Pre-alignment on save using external alignment service
- **Timing Preservation**: Maintains word-level timing data across edits
- **Version Control**: Complete edit history with diff patches
- **Segment-based Operations**: Efficient segment-level processing
- **User Confirmations**: Allows users to mark specific text ranges as confirmed

**Critical Design Principles:**
- **No Artificial Timing**: Never generates fake timing data
- **Fail Fast**: Exposes timing bugs rather than hiding them
- **Validation First**: Validates all timing data before processing

### Authentication (`explore/app/routes/auth.py`)

Google OAuth integration with fallback support.

**Key Routes:**
- `GET /login`: Login page with Google OAuth
- `GET /authorize`: OAuth authorization flow
- `GET /login/authorized`: OAuth callback handler
- `GET /logout`: Logout and session cleanup

**Features:**
- **Dual OAuth Support**: Authlib (preferred) and Flask-OAuthlib (fallback)
- **Development Mode**: Bypasses authentication when `TS_USER_EMAIL` is set
- **Analytics Integration**: Tracks login success/failure events
- **Session Management**: Proper session handling with redirect support

**Security:**
- **Environment Configuration**: OAuth credentials via environment variables
- **Session Security**: Proper session cleanup on logout
- **Redirect Protection**: Stores and redirects to requested URL after login

### Audio Serving (`explore/app/routes/audio.py`)

Robust audio file serving with range request support.

**Key Routes:**
- `GET /audio/<path:filename>`: Serve audio files with range support
- `GET /debug/audio/resolve`: Debug audio path resolution (dev only)
- `GET /debug/audio/reindex`: Rebuild audio index (dev only)
- `GET /debug/audio/scan`: Scan folder for audio files (dev only)

**Advanced Features:**
- **Range Requests**: HTTP 206 partial content support for streaming
- **Path Resolution**: Handles various audio storage layouts
- **Pointer Following**: Resolves Git LFS pointers to actual blob files
- **Windows Support**: Long path handling for Windows systems
- **Content Type Detection**: Proper MIME type handling for Opus files
- **Error Handling**: Comprehensive error logging and graceful fallbacks

**Performance Optimizations:**
- **Chunked Streaming**: 8KB chunks for efficient memory usage
- **Request Tracking**: UUID-based request tracking for debugging
- **Path Caching**: Audio index for fast path resolution

### Export Functionality (`explore/app/routes/export.py`)

Data export capabilities for search results and transcripts.

**Key Routes:**
- `GET /export/results/<query>`: Export search results as CSV
- `GET /export/segment/<source>/<filename>`: Export audio segments as MP3
- `GET /export/transcript/vtt`: Export transcript as WebVTT
- `GET /export/transcript/csv`: Export transcript as CSV
- `GET /export/transcript/json`: Export transcript as JSON

**Export Features:**
- **Multiple Formats**: CSV, VTT, JSON, MP3 support
- **Audio Processing**: FFmpeg integration for segment extraction
- **Excel Compatibility**: UTF-8 BOM for proper Excel import
- **Analytics Tracking**: Export event tracking for usage analytics
- **Error Handling**: Comprehensive error handling and logging

**Audio Export:**
- **Segment Extraction**: Precise audio segment cutting
- **Format Conversion**: Opus to MP3 conversion with quality settings
- **Streaming Output**: Direct streaming to client without temporary files

## Frontend (v2/)

### Main Application Entry Point

**`v2/main.js`** - The main bootstrap script that orchestrates the entire frontend application.

**Key Features:**
- **Application Bootstrap**: Initializes all core services, UI components, and event handlers
- **State Management**: Integrates with the centralized store for reactive updates
- **Virtualized Rendering**: Uses `ScrollVirtualizer` for efficient rendering of large transcript documents
- **Audio Synchronization**: Sets up player sync for seeking and playback coordination
- **Search Integration**: Implements search panel with pagination and result navigation
- **Editing Pipeline**: Coordinates modeless editing with diff and alignment workers
- **Browser Integration**: Manages folder/file navigation and document loading

**Critical Design Principles:**
- **No Artificial Timing**: Explicitly avoids generating artificial timing data in test scenarios
- **Worker Coordination**: Manages background workers for diff computation and alignment
- **Error Handling**: Comprehensive error handling with user-friendly messages
- **Performance Optimization**: Uses throttling, virtualization, and efficient event handling

**Key Functions:**
- `updateVersionBadge()`: Updates the version/hash display in the UI
- `safeSeekPlay()`: Handles audio seeking with proper error handling and fallbacks
- Search panel setup with pagination, keyboard navigation, and result enrichment
- Tab management for different UI panels (Browser/Search, Diff/History)
- Debug toggle functionality (Ctrl+Shift+D)

**Global State Management:**
- `editGen`: Global edit generation counter for tracking document changes
- `typingQuietUntil`: Timestamp for typing quiet window management
- `pending`: Tracks pending diff and alignment operations
- `showingLayers`: Controls diff pane display mode (layers vs diff)

**Worker Integration:**
- Initializes workers for diff computation and alignment
- Coordinates worker communication and result handling
- Manages worker lifecycle and cleanup

### Core State Management

**`v2/core/state.js`** - Implements a minimal, production-grade application store.

**Store Architecture:**
- **Shallow Merge Strategy**: Top-level shallow merge with deep merge for nested objects (playback/settings)
- **Referential Equality**: Maintains referential equality discipline for performance
- **Subscription Model**: Efficient listener management with automatic cleanup
- **Tagged Updates**: Supports tagged state updates for specific change notifications

**State Structure:**
- `text`: Latest saved text content
- `liveText`: Current contentEditable text
- `baselineText`: Original baseline transcript
- `baselineTokens`: Tokens aligned to baseline
- `tokens`: Currently rendered tokens
- `version`: Document version number
- `base_sha256`: Base document hash
- `playback`: Audio playback state (currentTime, rate, paused)
- `settings`: UI preferences (probEnabled, probThreshold)
- `confirmedRanges`: User-confirmed text ranges

**Key Methods:**
- `setState(patch, tag)`: Shallow merge with deep merge for nested objects
- `setLiveText(text)`: Updates live text with change notification
- `setTokens(tokens)`: Updates token array with referential equality
- `setBaseline({text, tokens})`: Sets baseline data for diff operations
- `setPlayback(partial)`: Updates playback state with deep merge
- `makeThrottle(fn, wait)`: Utility for throttling function calls

**Performance Optimizations:**
- **Change Detection**: Avoids unnecessary notifications when state hasn't changed
- **Selective Updates**: Only notifies listeners when relevant state changes
- **Throttling**: Built-in throttle utility for performance-critical operations

### Data Access Layer

**`v2/data/api.js`** - Comprehensive data access layer for backend integration.

**Backend Integration:**
- **Runtime Base Detection**: Automatically detects backend URL (localhost for file:// protocol)
- **Credential Handling**: Always includes credentials/cookies for authenticated requests
- **Error Handling**: Comprehensive error handling with Hebrew error messages
- **Retry Logic**: Implements retry logic for transient failures (database locks, 5xx errors)

**Authentication Flow:**
- **401 Handling**: Automatic redirect to login page on unauthorized access
- **Session Management**: Maintains session state across requests
- **CORS Support**: Handles cross-origin requests with proper credentials

**Transcript Management:**
- **Version Control**: Supports versioned transcript storage and retrieval
- **Conflict Detection**: Implements optimistic locking with version/hash conflicts
- **Word-Level Data**: Manages normalized word tokens with timing information
- **Alignment Integration**: Supports external alignment service integration

**Critical Design Principles:**
- **No Artificial Timing**: Explicitly avoids generating artificial timing data
- **Null Preservation**: Preserves null timing values to expose bugs rather than hiding them
- **Data Integrity**: Validates timing data for monotonicity and precision

**Key Functions:**
- `loadEpisode({folder, file})`: Loads complete episode data (audio, baseline, corrections)
- `saveTranscriptVersion()`: Saves transcript with conflict detection and retry logic
- `getTranscriptWords()`: Retrieves normalized word data with segment filtering
- `alignSegment()`: Triggers external alignment for specific segments
- `getAllTranscripts()`: Fetches version history for diff layers
- `saveConfirmations()`: Saves user confirmation data with context
- `sha256Hex()`: Computes SHA-256 hashes for conflict detection

**Data Normalization:**
- `normalizeTranscript()`: Ensures transcript structure integrity
- `flattenToTokens()`: Converts segments to flat token array
- `wordsToText()`: Reconstructs text from token array

**Crypto Implementation:**
- **SHA-256**: Implements SHA-256 hashing for conflict detection
- **Fallback Support**: Provides fallback implementation if CryptoJS unavailable
- **UTF-8 Handling**: Proper UTF-8 encoding for international text

### Search Integration

**`v2/data/search.js`** - Lightweight search API integration.

**Key Functions:**
- `search({q, page, perPage})`: Performs backend search with pagination
- `fetchSegments(lookups)`: Batch fetches segment details for search results
- `resultToEpisode(result)`: Converts search result to episode format

**Features:**
- **Pagination Support**: Handles page-based result navigation
- **Batch Operations**: Efficient bulk segment lookups
- **Error Handling**: Graceful fallback for failed requests
- **URL Parameter Mapping**: Converts search results to episode paths

### Browser Integration

**`v2/data/browser.js`** - Folder/file browser with race condition protection.

**Key Features:**
- **Race Condition Protection**: Uses AbortController and sequence numbers
- **Correction Status**: Shows green/red badges for transcript corrections
- **Auto-loading**: Automatically loads first file for smooth UX
- **Batch Processing**: Processes correction status in small batches

**Critical Design Principles:**
- **Load Sequence Tracking**: Prevents late/outdated results from overwriting current state
- **Desired Path Validation**: Only allows loads for the currently desired path
- **Error Recovery**: Comprehensive error handling with user feedback

**Key Functions:**
- `loadFolders()`: Loads and displays folder hierarchy
- `loadFiles(folderName)`: Loads files for a specific folder
- `loadEpisodeFile(folder, file)`: Loads complete episode data with race protection

### Virtualized Rendering

**`v2/render/virtualizer.js`** - Efficient rendering of large transcript documents.

**Key Features:**
- **Window-based Rendering**: Only renders visible tokens plus overscan
- **Scroll Synchronization**: Maintains scroll position during updates
- **Performance Optimization**: Throttled scroll handling and efficient updates

**Key Methods:**
- `setTokens(tokens)`: Updates token data and triggers re-render
- `setConfirmedRanges(ranges)`: Updates confirmed text highlighting
- `scrollToTokenIndex(index)`: Programmatically scrolls to specific token
- `updateActiveIndex(i)`: Updates karaoke highlighting

### Overlay Rendering

**`v2/render/overlay.js`** - Advanced rendering with probability highlighting and confirmed ranges.

**Key Features:**
- **Probability Highlighting**: Visual indication of low-confidence tokens
- **Confirmed Ranges**: User-confirmed text highlighting
- **Active Token Tracking**: Karaoke-style active token highlighting
- **Efficient Updates**: Minimal DOM manipulation for performance

**Critical Design Principles:**
- **No Artificial Timing**: Explicitly avoids generating artificial timing data
- **Null Preservation**: Preserves null timing values to expose bugs
- **Performance First**: Uses efficient binary search for range overlaps

**Key Classes:**
- `OverlayRenderer`: Main rendering class with windowing support
- `computeAbsIndexMap()`: Computes absolute text offsets for tokens

**Visual Features:**
- **Probability Tinting**: Background color based on confidence levels
- **Confirmed Highlighting**: Special styling for user-confirmed text
- **Active Token Ring**: Visual indication of current playback position

### Audio Player Synchronization

**`v2/player/sync.js`** - Synchronizes audio playback with application state.

**Key Features:**
- **Real-time Sync**: Uses requestAnimationFrame for smooth updates
- **External Seek Support**: Listens for custom seek events
- **Rate Control**: Handles playback rate changes
- **Event-driven Updates**: Publishes only when values change

**Performance Optimizations:**
- **Throttled Updates**: Capped publish frequency to prevent subscriber storms
- **Change Detection**: Only publishes when values actually change
- **Efficient Loops**: Uses rAF only during playback

**Key Methods:**
- `seekTo(time)`: Seeks to specific time position
- `setRate(rate)`: Changes playback rate
- `setPlaying(playing)`: Controls play/pause state

### Editing Pipeline

**`v2/editor/pipeline.js`** - Coordinates real-time editing with diff computation and alignment.

**Key Features:**
- **IME Support**: Proper handling of input method editors
- **Quiet Window**: Prevents processing during active typing
- **Generation Guards**: Prevents outdated operations from overwriting current state
- **Worker Coordination**: Manages diff and alignment workers

**Critical Design Principles:**
- **No Artificial Timing**: Explicitly avoids generating artificial timing data
- **Timing Preservation**: Preserves existing timing data when possible
- **Fail Fast**: Exposes timing bugs rather than hiding them

**Key Functions:**
- `tokensFromText(str)`: Simple tokenization without artificial timing
- `hasTiming(arr)`: Detects if tokens have valid timing data
- `scheduleDiffSync()`: Debounced diff computation
- `scheduleTokensFromText()`: Debounced token updates

**Input Handling:**
- **Composition Events**: Proper IME start/end handling
- **Input Events**: Real-time text updates
- **Selection Management**: Preserves cursor position during updates

### Worker Management

**`v2/workers/init.js`** - Initializes and manages web workers for background processing.

**Key Features:**
- **Diff Worker**: Handles text diff computation in background
- **RPC Wrapper**: Simple request/response pattern with message IDs
- **Error Handling**: Graceful worker crash handling
- **Ready State Tracking**: Monitors worker initialization

**Key Methods:**
- `send(base, current, options)`: Sends diff computation request
- `setBaseline(baselineText)`: Updates worker baseline text
- `isReady()`: Checks if workers are ready for processing

### User Interface Components

**`v2/ui/toast.js`** - Toast notification system.

**Features:**
- **Multiple Types**: Info, success, error notifications
- **Auto-dismiss**: Configurable timeout with default 2.5 seconds
- **Accessibility**: ARIA live region for screen readers
- **Debug Logging**: Console logging for development

**`v2/ui/theme.js`** - Theme management system.

**Features:**
- **Light/Dark Mode**: Toggle between themes
- **Persistence**: Saves theme preference to localStorage
- **Icon Updates**: Updates theme toggle icon
- **CSS Classes**: Applies theme classes to document root

**`v2/ui/controls.js`** - Comprehensive UI control system.

**Key Features:**
- **Probability Toggle**: Enable/disable confidence highlighting
- **VTT Export**: Generate and download WebVTT files
- **Font Size Controls**: Adjustable text size
- **Confirmation System**: Mark text ranges as reliable/unreliable
- **Save Functionality**: Complete save pipeline with conflict resolution

**Critical Design Principles:**
- **No Artificial Timing**: Explicitly avoids generating artificial timing data
- **Timing Validation**: Validates timing data for monotonicity and fake patterns
- **Conflict Resolution**: Advanced merge conflict handling with automatic resolution

**Advanced Features:**
- **Merge Conflict Resolution**: Automatic 3-way merge with conflict detection
- **Version Chain Verification**: Validates version integrity using SHA-256
- **Background Alignment**: Triggers external alignment service after save
- **Timing Data Preservation**: Carries over timing data during text changes

### Audio Synchronization

**`v2/player/karaoke.js`** - Karaoke-style audio synchronization.

**Key Features:**
- **Active Word Highlighting**: Highlights current word during playback
- **Gentle Auto-scroll**: Smooth scrolling to follow playback
- **Binary Search**: Efficient time-to-token mapping
- **Scroll Lock**: Respects temporary scroll locks during navigation

**Performance Optimizations:**
- **Index Caching**: Pre-computed timing arrays for fast lookup
- **Baseline Fallback**: Uses baseline tokens when current tokens are paging
- **Boundary Detection**: Handles edge cases and timing gaps

### History and Versioning

**`v2/history/show-layers.js`** - Version history and diff layers visualization.

**Key Features:**
- **Layer Rendering**: Shows all version changes as layers
- **Timing Edit Integration**: Displays timing adjustments alongside text changes
- **Worker Integration**: Uses diff workers for efficient computation
- **Debug Logging**: Comprehensive logging for development

**Data Flow:**
- Fetches all transcript versions
- Retrieves timing edit operations
- Computes diffs between versions
- Renders layered view with timing changes

## Critical Issues and Design Principles

### Timing Data Integrity

**CRITICAL PRINCIPLE**: The codebase explicitly avoids generating artificial timing data. This is a fundamental design principle that appears throughout multiple files:

- **`timing.py`**: "CRITICAL: This function should NEVER generate artificial timing data. If timing data is invalid, we should FAIL and expose the bug, not hide it."
- **`db_ops.py`**: "CRITICAL WARNING: This function should NOT generate artificial timing data. It should leave missing data as NULL/None and fail on invalid data."
- **`alignment.py`**: "CRITICAL: Do NOT generate artificial timing data with start: 0, end: 0"

This principle ensures data integrity and prevents silent failures in timing-sensitive operations.

### Authentication and Security

- **Google OAuth Integration**: Uses Authlib (preferred) with FlaskOAuth fallback
- **Session Management**: Secure session handling with proper cleanup
- **CORS Configuration**: Configurable CORS with environment-based origin control
- **Path Traversal Protection**: Input validation to prevent directory traversal attacks

### Performance Considerations

- **Database Optimization**: WAL mode, connection pooling, and query optimization
- **Indexing Strategy**: Efficient search indexing with SQLite UDFs
- **Caching**: In-memory audio index for fast path resolution
- **Concurrency Control**: Version-based conflict resolution for concurrent edits

### Error Handling

- **Comprehensive Error Capture**: All errors are captured via AnalyticsService
- **User-Friendly Messages**: Hebrew error messages for better user experience
- **Graceful Degradation**: Fallback mechanisms for missing services
- **Logging**: Structured logging with JSON formatting and rotation

### Advanced UI Components

**`v2/ui/merge-modal.js`** - Conflict resolution modal for concurrent edits.

**Key Features:**
- **Conflict Detection**: Shows diffs between parent, latest, and client versions
- **Resolution Options**: Reload latest or attempt auto-merge
- **Hash Mismatch Debug**: Displays expected vs actual hash information
- **User Guidance**: Provides tips for resolving conflicts

**`v2/ui/hud.js`** - Developer HUD for performance monitoring.

**Key Features:**
- **Render Metrics**: Shows virtualizer performance stats
- **Worker Timing**: Tracks diff and alignment worker execution times
- **Token Counts**: Displays visible vs total token statistics
- **Keyboard Toggle**: Ctrl+Alt+D to show/hide HUD
- **Auto-Refresh**: Updates on scroll and timer intervals

**`v2/ui/layout.js`** - Advanced layout management with scroll synchronization.

**Key Features:**
- **Scroll Sync**: Synchronizes transcript and diff panel scrolling
- **Resizable Gutters**: Drag-to-resize navigation and diff panels
- **Persistent Layout**: Saves panel widths to localStorage
- **Keyboard Nudging**: Arrow keys for fine panel adjustments
- **Conditional Sync**: Only syncs when diff tab is active

### Data Management

**`v2/data/words-pager.js`** - Incremental word loading system.

**Key Features:**
- **Chunked Loading**: Loads transcript words in segments (default 50)
- **Smart Skipping**: Avoids overriding complete data if already present
- **Segment Hints**: Optional jump-start near search result segments
- **Responsive Loading**: Small delays to keep UI responsive
- **Abort Support**: Can be stopped mid-loading

**`v2/history/panel.js`** - Version history sidebar.

**Key Features:**
- **Version Listing**: Shows all transcript versions with timestamps
- **Diff Preview**: Real-time diff computation against current version
- **User Attribution**: Shows who made each version
- **Error Handling**: Graceful fallback for failed operations
- **Auto-Refresh**: Updates on document changes

### Advanced Diff Processing

**`v2/workers/diff-worker.js`** - Sophisticated diff computation worker.

**Key Features:**
- **Myers Algorithm**: O(ND) diff algorithm for optimal results
- **Multi-Strategy**: Character-level, token-level, and line-level diffs
- **Granular Processing**: Line-level pairing with token refinement
- **Validation**: Reconstructs and validates diff accuracy
- **Fallback Support**: Multiple diff strategies with graceful degradation
- **External Integration**: Uses diff-match-patch library as backup

**`v2/workers/diff-core.js`** - Shared diff algorithms for browser and Node.js.

**Key Features:**
- **Pure JavaScript**: No web worker dependencies
- **Shared Logic**: Same algorithms used in tests and browser
- **Text Normalization**: Handles Unicode, line endings, and whitespace
- **Multiple Strategies**: Character, token, and line-level diff algorithms
- **Reconstruction**: Functions to rebuild original text from diffs

### History and Verification

**`v2/history/verify-chain.js`** - Hash chain verification system.

**Key Features:**
- **Direct Verification**: Compares latest text hash to stored SHA-256
- **Chain Validation**: Reconstructs text through edit history
- **Error Diagnosis**: Identifies specific failure points in the chain
- **Edit Replay**: Replays token operations to validate transformations
- **Robust Fallback**: Handles missing versions and malformed data

**`v2/history/layers-view.js`** - Visual diff layers for version history.

**Key Features:**
- **Layer Building**: Creates HTML from transcript version snapshots
- **Diff Integration**: Uses diff worker for change visualization
- **Timing Changes**: Shows timing adjustments alongside text changes
- **User Attribution**: Displays who made each change
- **Contextual Display**: Shows segment ranges and timing details

### Rendering and Display

**`v2/render/diff-panel.js`** - DMP-style diff renderer.

**Key Features:**
- **HTML Rendering**: Converts diff arrays to styled HTML
- **Operation Types**: Handles insertions, deletions, and equal content
- **HTML Escaping**: Safe rendering of user content
- **Visual Styling**: CSS classes for different operation types

### Legacy Search Results

**`explore/app/static/js/results.js`** - Comprehensive search results client.

**Key Features:**
- **Audio Management**: Single-instance audio player system
- **Lazy Loading**: Queue-based audio loading with intersection observer
- **Batch Processing**: Efficient segment fetching with debounced requests
- **Context Building**: Shows surrounding segments for each search result
- **Audio Synchronization**: Click-to-play with automatic stopping
- **Highlighting**: Query term highlighting in search results
- **Error Handling**: Graceful fallbacks for failed operations

**Architecture Highlights:**
- **Performance**: Uses Map for O(1) lookups and Set for deduplication
- **Memory Management**: Efficient caching and cleanup
- **User Experience**: Responsive loading with visual feedback
- **Scalability**: Handles large result sets with batch operations

### Shared Utilities

**`v2/shared/canonical.js`** - Text canonicalization for stability.

**Key Functions:**
- `canonicalizeText(s)`: Normalizes Unicode, removes control characters
- `lineTrim(a, b)`: Trims unchanged prefix/suffix by lines

**Features:**
- **Unicode Handling**: NFC normalization and control character removal
- **Line Processing**: Efficient line-based diff trimming
- **Error Safety**: Graceful fallbacks for malformed input

## Frontend Architecture Summary

The frontend is built as a sophisticated single-page application with the following architectural patterns:

### Performance Optimization
1. **Virtualization**: Large transcript documents use virtual scrolling
2. **Worker Threading**: CPU-intensive operations run in web workers
3. **Batch Processing**: API calls are batched and debounced
4. **Lazy Loading**: Content loaded on-demand with intersection observers

### User Experience
1. **Real-time Feedback**: Immediate visual feedback for all actions
2. **Conflict Resolution**: Clear workflows for concurrent edit conflicts
3. **Accessibility**: Proper ARIA attributes and keyboard navigation
4. **Internationalization**: Hebrew text support with RTL handling

### Data Integrity
1. **Hash Verification**: Multiple layers of SHA-256 verification
2. **Version Control**: Comprehensive versioning with edit deltas
3. **Chain Validation**: Reconstructs and validates edit history
4. **No Artificial Data**: Explicitly avoids generating fake timing data

## Testing and Quality Assurance

### End-to-End Testing

**`e2e/editor.spec.ts`** - Comprehensive E2E test suite for the transcript editor.

**Key Test Scenarios:**
- **Load → Edit → Save → Version Badge**: Tests basic editing workflow with version tracking
- **409 Conflict → Merge Modal → Auto-merge**: Tests concurrent edit conflict resolution
- **Confirmations Select → Save → Reload**: Tests user confirmation workflow
- **Word Replacement Timing Preservation**: Validates timing data integrity during edits
- **Zeroed Timings Prevention**: Ensures alignment doesn't create artificial timing data

**Critical Testing Principles:**
- **No Artificial Timing**: Tests explicitly avoid generating fake timing data
- **Monotonicity Validation**: Strict validation of timing data monotonicity
- **Hash Chain Verification**: Tests validate SHA-256 hash chains
- **Error Detection**: Comprehensive browser console error monitoring
- **Data Integrity**: Downloads timing data for offline analysis

**Test Infrastructure:**
- **Playwright Integration**: Uses Playwright for browser automation
- **Backend Startup**: Spawns Python backend server for testing
- **Temporary Data**: Creates isolated test data in temporary directories
- **Error Handling**: Fails fast on browser errors to prevent test pollution

**`playwright.config.ts`** - Playwright configuration for E2E testing.

**Configuration Features:**
- **Extended Timeouts**: 45s test timeout, 30s expect timeout, 90s action timeout
- **Single Worker**: Prevents test interference with sequential execution
- **Fail Fast**: Stops on first failure to avoid wasting time
- **Trace Collection**: Enables tracing on first retry for debugging

### Production Deployment

**`explore/start.sh`** - Production deployment script using uWSGI.

**Key Features:**
- **HTTPS Configuration**: Uses Let's Encrypt certificates
- **Process Management**: 2 processes, 4 threads per process
- **Logging**: Comprehensive logging with 4xx/5xx error tracking
- **Timeout Handling**: 30s harakiri timeout for hanging requests
- **Virtual Environment**: Activates Python virtual environment

### Administrative Tools

**`explore/app/cli.py`** - Command-line interface for system administration.

**Commands:**
- **`reindex`**: Rebuilds search index from transcript JSON files
- **`stats`**: Prints index statistics and sample data

**Key Features:**
- **Click Integration**: Modern CLI framework with help text
- **Path Validation**: Validates data directories and file paths
- **Progress Reporting**: Shows indexing progress and statistics
- **Error Handling**: Graceful handling of missing files and directories

### Route Handlers (Additional)

**`explore/app/routes/browser.py`** - File system browser API.

**Key Endpoints:**
- **`/folders`**: Lists available folder directories
- **`/files`**: Lists files within a specific folder
- **`/episode`**: Retrieves transcript and audio URL for a specific episode

**Features:**
- **Audio File Detection**: Identifies audio files by extension (.opus, .mp3, .wav, .m4a)
- **Fallback Logic**: Falls back to transcript-based file discovery
- **Path Safety**: Prevents directory traversal attacks
- **Multiple Layouts**: Supports both nested and flat directory structures

**`explore/app/routes/frontend.py`** - Frontend static file serving.

**Key Features:**
- **V2 Application**: Serves the v2/ directory as the main application
- **Path Resolution**: Resolves v2 directory relative to repository root
- **Security**: Prevents directory traversal attacks
- **Static Assets**: Serves all v2/ static files (JS, CSS, images)

**`explore/app/routes/testing.py`** - Testing utilities and database reset.

**Key Features:**
- **Database Reset**: `/testing/reset-db` endpoint for test isolation
- **File Cleanup**: Removes SQLite, WAL, and SHM files
- **Connection Management**: Properly closes database connections
- **Schema Reinitialization**: Rebuilds database schema after reset

**`explore/app/routes/_helpers.py`** - Legacy compatibility shims.

**Purpose:**
- **Backward Compatibility**: Maintains compatibility with older code paths
- **Function Delegation**: Delegates to modern transcript modules
- **Import Mapping**: Maps legacy imports to new module structure
- **API Stability**: Ensures existing code continues to work

### Worker Implementation

**`workers/diff-core.js`** - Deterministic diff algorithm implementation.

**Key Features:**
- **Pure JavaScript**: No external dependencies or web worker APIs
- **Myers Algorithm**: O(ND) diff algorithm implementation
- **Multi-Level Processing**: Character, token, and line-level diff strategies
- **Text Normalization**: Handles Unicode, line endings, and whitespace
- **Reconstruction**: Functions to rebuild original text from diffs

**Algorithm Details:**
- **Common Prefix/Suffix**: Optimizes by skipping unchanged portions
- **Token-Level Refinement**: Uses Unicode-aware tokenization
- **Line-Level Pairing**: Groups changes by lines for better readability
- **Validation**: Reconstructs and validates diff accuracy

## System Architecture Summary

### Backend Architecture
1. **Flask Application**: Modular blueprint-based architecture
2. **Database Layer**: SQLite with WAL mode and connection pooling
3. **Search Engine**: Custom indexing with SQLite UDFs
4. **Authentication**: Google OAuth with session management
5. **Analytics**: PostHog integration for user tracking
6. **Audio Processing**: FFmpeg integration for audio manipulation
7. **External Services**: Alignment service integration

### Frontend Architecture
1. **Single Page Application**: Modern JavaScript with ES6 modules
2. **State Management**: Centralized reactive state system
3. **Virtual Scrolling**: Efficient rendering of large documents
4. **Web Workers**: Background processing for CPU-intensive tasks
5. **Real-time Updates**: Live editing with conflict resolution
6. **Audio Synchronization**: Precise audio-text alignment
7. **Responsive Design**: Adaptive layout with resizable panels

### Data Flow
1. **Transcript Ingestion**: Gzipped JSON files with segment data
2. **Index Building**: Parallel processing with progress tracking
3. **Search Processing**: Regex-based search with pagination
4. **Edit Pipeline**: Version control with hash verification
5. **Alignment Processing**: External service integration for timing
6. **Export Generation**: Multiple formats (CSV, VTT, JSON)

### Quality Assurance
1. **E2E Testing**: Comprehensive Playwright test suite
2. **Data Validation**: Strict timing data integrity checks
3. **Error Monitoring**: Browser console error detection
4. **Performance Testing**: Timing data monotonicity validation
5. **Conflict Testing**: Concurrent edit scenario testing

## Additional Components and Infrastructure

### Worker Implementation (Advanced)

**`workers/align-worker.js`** - Advanced alignment worker for timing preservation.

**Key Features:**
- **Token Alignment**: Aligns edited text back to timing-bearing tokens
- **LCS Algorithm**: Uses Longest Common Subsequence for optimal alignment
- **Timing Assignment**: Assigns timing to inserted tokens using anchor windows
- **Monotonicity Enforcement**: Ensures timing data remains monotonic
- **Whitespace Handling**: Special handling for whitespace tokens as zero-length anchors

**Algorithm Details:**
- **Baseline Normalization**: Splits whitespace into zero-length anchors
- **Anchor Windowing**: Uses surrounding tokens to determine timing windows
- **Insertion Timing**: Distributes timing across inserted word sequences
- **Global Monotonicity**: Enforces non-decreasing start times across all tokens

**`v2/shared/protocol.js`** - Shared message protocol definitions.

**Key Features:**
- **Worker Communication**: Defines message types for diff and align workers
- **Edit Operations**: Standardized edit operation codes (DELETE, EQUAL, INSERT)
- **Type Definitions**: JSDoc typedefs for Token, ConfirmationRange, VersionMeta
- **Dependency-Free**: Minimal shared definitions without external dependencies

### Development and Deployment

**`dev.sh`** - Development server startup script.

**Key Features:**
- **Virtual Environment**: Activates Python virtual environment if present
- **Argument Parsing**: Supports custom data directory and dev mode flags
- **Error Handling**: Validates Python installation and provides clear error messages
- **Flexible Configuration**: Allows both development and production modes

**`package.json`** - Node.js project configuration for E2E testing.

**Key Features:**
- **Playwright Testing**: E2E testing framework with browser automation
- **TypeScript Support**: Type definitions for Node.js
- **Crypto Dependencies**: SHA-256 hashing for data integrity
- **Script Commands**: Standardized testing commands with different modes

### Containerization

**`Dockerfile`** - Multi-stage Docker build for production deployment.

**Key Features:**
- **Multi-Stage Build**: Optimized build process with separate builder and runtime stages
- **Python 3.11**: Modern Python runtime with slim base image
- **FFmpeg Integration**: Includes FFmpeg for audio processing and alignment
- **Virtual Environment**: Isolated Python dependencies
- **Gunicorn WSGI**: Production WSGI server with proper configuration

**`docker-compose.yml`** - Docker Compose configuration for development.

**Key Features:**
- **Development Environment**: Hot-reload code and static files
- **Volume Mounting**: Live data access and code synchronization
- **Environment Variables**: Development-specific configuration
- **Port Mapping**: Exposes Flask application on port 5000

## Final Analysis Summary

### Repository Overview
The `sonar-test` repository is a sophisticated transcript management and search system built with modern web technologies. It combines a Flask backend with a cutting-edge JavaScript frontend to provide a comprehensive solution for Hebrew transcript editing, search, and audio synchronization.

### Key Strengths

1. **Data Integrity Focus**: The system places exceptional emphasis on data integrity, with explicit warnings against generating artificial timing data and comprehensive validation mechanisms.

2. **Advanced Diff Algorithms**: Implements sophisticated diff algorithms including Myers O(ND) algorithm with multi-level processing (character, token, and line-level).

3. **Real-time Collaboration**: Features conflict detection and resolution for concurrent edits with hash-based version control.

4. **Performance Optimization**: Uses virtual scrolling, web workers, batch processing, and lazy loading to handle large datasets efficiently.

5. **Comprehensive Testing**: Extensive E2E testing with Playwright, including timing data integrity validation and monotonicity checks.

6. **Production Ready**: Full containerization with Docker, production deployment scripts, and comprehensive logging.

### Technical Architecture

**Backend (Flask)**:
- Modular blueprint-based architecture
- SQLite with WAL mode and custom UDFs
- Google OAuth authentication
- PostHog analytics integration
- External alignment service integration
- Comprehensive error handling and logging

**Frontend (JavaScript)**:
- Modern ES6 module architecture
- Centralized reactive state management
- Virtual scrolling for performance
- Web workers for CPU-intensive tasks
- Real-time conflict resolution
- Responsive design with resizable panels

### Critical Design Principles

1. **No Artificial Data**: Explicitly avoids generating fake timing data
2. **Hash Verification**: Multiple layers of SHA-256 verification
3. **Version Control**: Comprehensive versioning with edit deltas
4. **Monotonicity**: Strict enforcement of timing data monotonicity
5. **Error Transparency**: Fails fast to expose bugs rather than hiding them

### Quality Assurance

The system includes comprehensive quality assurance measures:
- E2E testing with browser automation
- Timing data integrity validation
- Hash chain verification
- Conflict resolution testing
- Performance monitoring
- Error detection and logging

### Deployment and Operations

- Production-ready Docker containerization
- Development environment with hot-reload
- Comprehensive logging and monitoring
- Health checks and error reporting
- Scalable architecture with worker processes

---

*This README provides a comprehensive overview of the sonar-test repository, covering both the backend Flask application and the frontend JavaScript application. The analysis reveals a sophisticated system for transcript management, search, and editing with strong emphasis on data integrity, performance, and user experience. The repository demonstrates excellent software engineering practices with comprehensive testing, documentation, and production-ready deployment infrastructure.*

